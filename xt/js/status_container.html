<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>StatusContainer tests</title>
    <link rel="stylesheet" href="qunit.css">
  </head>
  <body>
    <div id="spinner"></div>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script src="qunit.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="./sinon.js"></script>
    <script src="./uri.js"></script>
    <script src="../../share/www/static/q.js"></script>
    <script src="../../share/www/static/busybird.js"></script>
    <script src="../../share/www/static/timeline.js"></script>
    <script type="text/javascript">
"use strict";

var is = strictEqual;

var createStatusHTML = function(id, level) {
    if(!level) level = 0;
    return '<li class="bb-status" data-bb-status-level="'+level+'">' +
           '<span class="bb-status-id">'+id+'</span></li>';
};

var createStatus = function(id, level) {
    return $(createStatusHTML(id, level));
};

var createStatusDOM = function(id, level) {
    return createStatus(id, level).get(0);
};

var setupContainer = function() {
    $('<ul id="bb-status-container"></ul>').appendTo("#qunit-fixture");
    return new bb.StatusContainer("#bb-status-container");
};

var getStatuses = function() {
    return $("#bb-status-container").children();
};

var isVisible = function($elem) {
    return ($elem.css("display") !== "none");
};

var getContent = function($statuses) {
    if(!defined($statuses)) $statuses = getStatuses();
    return $statuses.map(function() {
        var $this = $(this);
        if($this.hasClass("bb-status")) {
            return isVisible($this) ? $this.find(".bb-status-id").text() : null;
        }else if($this.hasClass("bb-hidden-statuses-header")) {
            return {hidden: parseInt($this.find(".bb-hidden-statuses-num").text(), 10)};
        }else {
            throw "Unknown DOM element in container";
        }
    }).get();
};

var appendStatusesFromMeta = function(container, status_list) {
    return container.appendStatuses($.map(status_list, function(elem) {
        return createStatusDOM(elem.id, elem.level);
    }));
};

var FakeStatusServer = function(unacked_num, acked_num) {
    var self = this;
    self.status_top = 0;
    self.status_acked_top = self.status_top + unacked_num;
    self.status_bottom = self.status_acked_top + acked_num;
    self.fakeserver = sinon.fakeServer.create();
    self.fakeserver.respondWith(function(req) { self.respondTo(req) });
    self.fakeserver.autoRespond = true;
};
FakeStatusServer.prototype = {
    restore: function() { this.fakeserver.restore() },
    _respondWithStatuses: function(request, start_id, end_id) {
        var id;
        var response_string = "";
        for(id = start_id ; id < end_id ; id++) {
            response_string += createStatusHTML(id, 0);
        }
        request.respond(200, {"Content-Type": "text/html; charset=utf8"}, response_string);
    },
    _respondWithNoStatus: function(request) {
        this._respondWithStatuses(request, 0, 0);
    },
    respondTo: function(request) {
        var self = this;
        var request_url = URI.parse(request.url);
        var query = URI.parseQuery(request_url.query || "");
        var ack_state = defined(query.ack_state) ? query.ack_state : "any";
        var count = defined(query.count) ? parseInt(query.count, 10) : 20;
        var max_id = defined(query.max_id) ? parseInt(query.max_id, 10) :
                     ack_state === "acked" ? self.status_acked_top :
                                             self.status_top;
        var boundary = (ack_state === "unacked") ? {begin: self.status_top, end: self.status_acked_top} :
                       (ack_state === "acked")   ? {begin: self.status_acked_top, end: self.status_bottom} :
                                                   {begin: self.status_top, end: self.status_bottom};
        var request_bottom_id = max_id + count;
        if(max_id < boundary.begin || boundary.end <= max_id) {
            self._respondWithNoStatus(request);
            return;
        }
        self._respondWithStatuses(request, max_id,
                                  request_bottom_id <= boundary.end ? request_bottom_id : boundary.end);
    }
};

asyncTest("FakeStatusServer", function() {
    var server = new FakeStatusServer(10, 10);
    var baseurl = "/timelines/test/statuses.html";
    bb.ajaxRetry({cache: false, tryMax: 2,url: baseurl+"?ack_state=any&max_id=5&count=100"}).promise.then(function(data) {
        var $statuses = $(data);
        is($statuses.filter("li").size(), 15, "any, max_id=5, count=100 OK");
        return bb.ajaxRetry({cache: false, url: baseurl+"?ack_state=unacked&count=20"}).promise;
    }).then(function(data) {
        var $statuses = $(data);
        is($statuses.filter("li").size(), 10, "unacked, count=20 OK");
        return bb.ajaxRetry({cache: false, url: baseurl+"?ack_state=acked&count=3&max_id=13"}).promise;
    }).then(function(data) {
        is($(data).filter("li").size(), 3, "acked, max_id=13, count=3 OK");
        return bb.ajaxRetry({cache: false, url: baseurl+"?ack_state=unacked&max_id=14&count=100"}).promise;
    }).then(function(data) {
        is($(data).filter("li").size(), 0, "unacked, max_id in acked OK");
    }).fail(function(reason) {
        ok(false, "should not fail");
    }).then(function() {
        server.restore();
        start();
    });
});

test("append and prepend", function() {
    var container = setupContainer();
    container.appendStatuses([createStatusDOM(0)]);
    container.appendStatuses([createStatusDOM(1)]);
    container.prependStatuses([createStatusDOM(2)]);
    deepEqual(getContent(), ["2","0","1"], "status IDs OK");
    container.appendStatuses([createStatusDOM(3), createStatusDOM(4)]);
    deepEqual(getContent(), ["2", "0", "1", "3", "4"], "status IDs OK");
    container.prependStatuses([createStatusDOM(5), createStatusDOM(6)]);
    deepEqual(getContent(), ["5", "6", "2", "0", "1", "3", "4"], "status IDs OK");
});

asyncTest("setDisplayByThreshold", function() {
    var con = setupContainer();
    var status_list = [
        {id: 0, level: 0},
        {id: 1, level: 1},
        {id: 2, level: 2},
        {id: 3, level: -1},
        {id: 4, level: 1},
        {id: 5, level: -1},
        {id: 6, level: 0},
        {id: 7, level: 0}
    ];
    Q.fcall(function() {
        return con.setThresholdLevel(-10);
    }).then(function() {
        return appendStatusesFromMeta(con, status_list);
    }).then(function() {
        deepEqual(getContent(), ["0", "1", "2", "3", "4", "5", "6", "7"], "all displayed OK");
    }).then(function() {
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: 0});
    }).then(function() {
        deepEqual(getContent(), ["0", "1", "2", {hidden: 1}, "4", {hidden: 1}, "6", "7"], "threshold 0 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: 1});
    }).then(function() {
        deepEqual(getContent(), [{hidden: 1}, "1", "2", {hidden: 1}, "4", {hidden: 3}], "threshold 1 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: 2});
    }).then(function() {
        deepEqual(getContent(), [{hidden: 2}, "2", {hidden: 5}], "threshold 2 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: 3});
    }).then(function() {
        deepEqual(getContent(), [{hidden: 8}], "threshold 3 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: -1});
    }).then(function() {
        deepEqual(getContent(), ["0", "1", "2", "3", "4", "5", "6", "7"], "threshold -1 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses().slice(4,7), threshold: 10});
    }).then(function() {
        deepEqual(getContent(), ["0", "1", "2", "3", {hidden: 3}, "7"], "partial threshold 10 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses().slice(1,4), threshold: 2});    
    }).then(function() {
        deepEqual(getContent(), ["0", {hidden: 1}, "2", {hidden: 1}, {hidden: 3}, "7"], "partial threshold 2 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: 2});
    }).then(function() {
        deepEqual(getContent(), [{hidden: 2}, "2", {hidden: 5}], "global threshold reduces successive hidden headers");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: 3});
    }).then(function() {
        deepEqual(getContent(), [{hidden: 8}], "threshold 2 -> 3 OK again");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: 2});
    }).then(function() {
        deepEqual(getContent(), [{hidden: 2}, "2", {hidden: 5}], "threshold 3 -> 2 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: 1});
    }).then(function() {
        deepEqual(getContent(), [{hidden: 1}, "1", "2", {hidden: 1}, "4", {hidden: 3}], "threshold 2 -> 1 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: 0});
    }).then(function() {
        deepEqual(getContent(), ["0", "1", "2", {hidden: 1}, "4", {hidden: 1}, "6", "7"], "threshold 1 -> 0 OK");
        return bb.StatusContainer.setDisplayByThreshold({$statuses: getStatuses(), threshold: -1});
    }).then(function() {
        deepEqual(getContent(), ["0", "1", "2", "3", "4", "5", "6", "7"], "threshold 0 -> -1 OK");
    }).fail(function(reason) {
        ok(false, "should not fail");
        ok(true, "failure reason: " + reason);
    }).then(function() {
        start();
    });
});

asyncTest("set/getThresholdLevel", function() {
    var con = setupContainer();
    var status_list = [
        {id:  0, level: 0},
        {id:  1, level: 0},
        {id:  2, level: -1},
        {id:  3, level: 3},
        {id:  4, level: 2},
        {id:  5, level: 0},
        {id:  6, level: 1},
        {id:  7, level: 1},
        {id:  8, level: 3},
        {id:  9, level: 3},
        {id: 10, level: 2},
        {id: 11, level: -1},
    ];
    var old_duration = bb.StatusContainer.ANIMATE_STATUS_DURATION;
    var old_animate_max = bb.StatusContainer.ANIMATE_STATUS_MAX_NUM;
    bb.StatusContainer.ANIMATE_STATUS_DURATION = 5;
    bb.StatusContainer.ANIMATE_STATUS_MAX_NUM = 5;
    Q.fcall(function() {
        return appendStatusesFromMeta(con, status_list);
    }).then(function() {
        is(con.getThresholdLevel(), 0, "threshold level is 0 at first");
        deepEqual(getContent(), ["0", "1", {hidden: 1}, "3", "4", "5", "6", "7", "8", "9", "10", {hidden: 1}], "threshold 0 display OK");
        return con.setThresholdLevel(1);
    }).then(function() {
        is(con.getThresholdLevel(), 1, "getThresholdLevel 1 OK");
        deepEqual(getContent(), [{hidden: 3}, "3", "4", {hidden: 1}, "6", "7", "8", "9", "10", {hidden: 1}],
                  "threshold 1 display OK");
        return con.setThresholdLevel(2);
    }).then(function() {
        is(con.getThresholdLevel(), 2, "getThresholdLevel 2 OK");
        deepEqual(getContent(), [{hidden: 3}, "3", "4", {hidden: 3}, "8", "9", "10", {hidden: 1}],
                  "threshold 2 display OK");
        return con.setThresholdLevel(3);
    }).then(function() {
        is(con.getThresholdLevel(), 3, "getThresholdLevel 3 OK");
        deepEqual(getContent(), [{hidden: 3}, "3", {hidden: 4}, "8", "9", {hidden: 2}],
                  "threshold 3 display OK");
        return con.setThresholdLevel(4);
    }).then(function() {
        is(con.getThresholdLevel(), 4, "getThresholdLevel 4 OK");
        deepEqual(getContent(), [{hidden: 12}],
                  "threshold 4 display OK");
        return con.setThresholdLevel(10);
    }).then(function() {
        is(con.getThresholdLevel(), 10, "getThresholdLevel 10 OK");
        deepEqual(getContent(), [{hidden: 12}],
                  "threshold 10 display OK");
        return con.setThresholdLevel(3);
    }).then(function() {
        is(con.getThresholdLevel(), 3, "getThresholdLevel 3 OK");
        deepEqual(getContent(), [{hidden: 3}, "3", {hidden: 4}, "8", "9", {hidden: 2}],
                  "threshold 10 -> 3 display OK");
        return con.setThresholdLevel(2);
    }).then(function() {
        is(con.getThresholdLevel(), 2, "getThresholdLevel 2 OK");
        deepEqual(getContent(), [{hidden: 3}, "3", "4", {hidden: 3}, "8", "9", "10", {hidden: 1}],
                  "threshold 3 -> 2 display OK");
        return con.setThresholdLevel(1);
    }).then(function() {
        is(con.getThresholdLevel(), 1, "getThresholdLevel 1 OK");
        deepEqual(getContent(), [{hidden: 3}, "3", "4", {hidden: 1}, "6", "7", "8", "9", "10", {hidden: 1}],
                  "threshold 2 -> 1 display OK");
        return con.setThresholdLevel(0);
    }).then(function() {
        is(con.getThresholdLevel(), 0, "getThresholdLevel 0 OK");
        deepEqual(getContent(), ["0", "1", {hidden: 1}, "3", "4", "5", "6", "7", "8", "9", "10", {hidden: 1}],
                  "threshold 1 -> 0 display OK");
        return con.setThresholdLevel(-1);
    }).then(function() {
        is(con.getThresholdLevel(), -1, "getThresholdLevel -1 OK");
        deepEqual(getContent(), ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11"],
                  "threshold 0 -> -1 display OK");
        return con.setThresholdLevel(-10);
    }).then(function() {
        is(con.getThresholdLevel(), -10, "getThresholdLevel -10 OK");
        deepEqual(getContent(), ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11"],
                  "threshold -1 -> -10 display OK");
    }).fail(function(reason) {
        ok(false, "should not fail");
        ok(true, "failure reason: " + reason);
    }).then(function() {
        bb.StatusContainer.ANIMATE_STATUS_DURATION = old_duration;
        bb.StatusContainer.ANIMATE_STATUS_MAX_NUM = old_animate_max;
        start();
    });
});

asyncTest("loadStatuses", function() {
    var server = new FakeStatusServer(10, 50);
    Q.fcall(function() {
        return bb.StatusContainer.loadStatuses({
            apiURL: "/timelines/test/statuses.html", ackState: "unacked",
            countPerPage: 3, maxPageNum: 100
        });
    }).then(function(result) {
        is(result.maxReached, false, "load unacked: maxReached false");
        is(result.numRequests, 5, "load unacked: 5 requests");
        deepEqual(getContent($(result.statuses)), ["0","1","2","3","4","5","6","7","8","9"], "statuses OK");
        return bb.StatusContainer.loadStatuses({
            apiURL: "/timelines/test/statuses.html", ackState: "unacked",
            countPerPage: 10, maxPageNum: 100
        });
    }).then(function(result) {
        is(result.maxReached, false, "load unacked: maxReached false");
        is(result.numRequests, 2, "load unacked: 2 requests needed to determine if all unacked statuses are loaded");
        deepEqual(getContent($(result.statuses)), ["0","1","2","3","4","5","6","7","8","9"], "statuses OK");
        return bb.StatusContainer.loadStatuses({
            apiURL: "/timelines/test/statuses.html", ackState: "unacked",
            countPerPage: 3, maxPageNum: 2
        });
    }).then(function(result) {
        is(result.maxReached, true, "load unacked: maxReached true");
        is(result.numRequests, 2, "load unacked: only 2 requests are allowed.");
        deepEqual(getContent($(result.statuses)), ["0", "1", "2", "3", "4"], "statuses OK");
        return bb.StatusContainer.loadStatuses({
            apiURL: "/timelines/test/statuses.html", ackState: "acked",
            countPerPage: 5, maxPageNum: 1
        });
    }).then(function(result) {
        is(result.maxReached, true, "load acked: maxReached true");
        is(result.numRequests, 1, "load acked: load 1 page");
        deepEqual(getContent($(result.statuses)), ["10", "11", "12", "13", "14"], "statuses OK");
        return bb.StatusContainer.loadStatuses({
            apiURL: "/timelines/test/statuses.html", ackState: "any",
            startMaxID: "51", countPerPage: 20, maxPageNum: 1
        });
    }).then(function(result) {
        is(result.maxReached, false, "load acked: max not reached because loaded count is lower than the requested count");
        is(result.numRequests, 1, "load acked: load 1 page");
        deepEqual(getContent($(result.statuses)), ["51", "52", "53", "54", "55", "56", "57", "58", "59"], "statuses OK");
    }).fail(function(reason) {
        ok(false, "should not fail");
        ok(true, "reason: " + reason);
    }).then(function() {
        server.restore();
        start();
    });
});

    </script>
  </body>
</html>
