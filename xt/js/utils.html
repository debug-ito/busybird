<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Utility functions tests</title>
    <link rel="stylesheet" href="qunit.css">
  </head>
  <body>
    <div id="mb"></div>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script src="qunit.js"></script>
    <script src="sinon.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
    <script src="../../share/www/static/jsdeferred.js"></script>
    <script src="../../share/www/static/busybird.js"></script>
    <script type="text/javascript">

var is = strictEqual;
var faketimer;

function fakeTimer() {
    if(defined(faketimer)) {
        faketimer.restore();
    }
    faketimer = sinon.useFakeTimers();
}

var fakeserver;

// SlowStartServer starts slowly.
// At first it responds with 404 for fail_num times.
// After that it starts responding with 200.
var SlowStartServer = function(fail_num) {
    var self = this;
    self.fail_num = fail_num;
    self.count = 0;
    self.reqs = [];
    self.xhr = sinon.useFakeXMLHttpRequest();
    self.xhr.onCreate = function(req) {
        self.reqs.push(req);
    };
};
SlowStartServer.prototype = {
    pendingNum: function() { return this.reqs.length },
    respond: function() {
        var self = this;
        var i, request;
        for(i = 0 ; i < self.reqs.length ; i++) {
            request = self.reqs[i];
            if(self.count < self.fail_num) {
                request.respond(404, {"Content-Type": "text/plain"}, "" + self.count);
            }else {
                request.respond(200, {"Content-Type": "text/plain"}, "" + self.count);
            }
            self.count++;
        }
        self.reqs = [];
    },
    restore: function() { this.xhr.restore() },
};

test("ajaxRetry (succeed at first request)", function() {
    var res;
    // serverSlowStart(0);
    fakeserver = new SlowStartServer(0);
    bb.ajaxRetry({url: "/"}).next(function(data) {
        res = data;
    });
    ok(!defined(res), "response is not returned yet");
    is(fakeserver.pendingNum(), 1, "1 request pending");
    fakeserver.respond();
    is(res, "0", "response received at count = 0");
    fakeserver.restore();
});

test("ajaxRetry (fail several times)", function() {
    var res;
    // serverSlowStart(5);
    fakeserver = new SlowStartServer(5);
    fakeTimer();
    bb.ajaxRetry({url: "/"}).next(function(data) { res = data });
    ok(!defined(res), "response is not returned yet");
    is(fakeserver.pendingNum(), 1, "1 request pending");
    fakeserver.respond();
    is(fakeserver.pendingNum(), 0, "0 request pending");
    faketimer.tick(200);
    is(fakeserver.pendingNum(), 0, "0 request pending (not yet requested)");
    faketimer.tick(200000);
    is(fakeserver.pendingNum(), 1, "1 request pending");
    fakeserver.respond();
    faketimer.tick(1000);
    is(fakeserver.pendingNum(), 0, "0 request pending (retry backoff)");
    faketimer.tick(200000);
    is(fakeserver.pendingNum(), 1, "1 request pending");
    fakeserver.respond();
    faketimer.tick(200000);
    fakeserver.respond();
    faketimer.tick(200000);
    fakeserver.respond();
    ok(!defined(res), "response is not returned yet");
    faketimer.tick(200000);
    fakeserver.respond();
    is(res, "5", "response received at count = 5");
    fakeserver.restore();
});

test("ajaxRetry (cancel)", function() {
    var req_deferred;
    var ajax_xhr;
    var ajax_spy = sinon.spy(jQuery, "ajax");
    var ajax_abort_spy;
    var next_executed = false;
    var error_executed = false;
    fakeserver = new SlowStartServer(0)
    req_deferred = bb.ajaxRetry({url: "/"});
    req_deferred.next(function() { next_executed = true })
        .error(function() { error_executed = true });
    is(fakeserver.pendingNum(), 1, "1 pending request");
    is(ajax_spy.callCount, 1, "$.ajax() called once");
    ajax_xhr = ajax_spy.getCall(0).returnValue;
    ajax_abort_spy = sinon.spy(ajax_xhr, "abort");
    req_deferred.cancel();
    is(ajax_abort_spy.callCount, 1, "ajaxXHR.abort() called once");
    ok(!next_executed, "next callback is not executed");
    ok(!error_executed, "error callback is not executed");
    fakeserver.restore();
});

test("ajaxRetry (tryMax)", function() {
    var next_executed = false;
    var error_executed = false;
    fakeserver = new SlowStartServer(1);
    bb.ajaxRetry({url: "/", tryMax: 1}).next(function() {
        next_executed = true;
    }).error(function() {
        error_executed = true;
    });
    is(fakeserver.pendingNum(), 1, "1 pending request");
    ok(!next_executed, "next callback is not executed");
    ok(!error_executed, "error callback is not executed");
    fakeserver.respond();
    ok(!next_executed, "next callback is not executed");
    ok(error_executed, "error callback is executed");
    fakeserver.restore();
});


    </script>
  </body>
</html>

